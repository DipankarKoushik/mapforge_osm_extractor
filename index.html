<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapForge</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* --- SIDEBAR --- */
        #sidebar { 
            width: 320px; background: #f8f9fa; padding: 20px; 
            border-right: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto;
        }

        /* NEW: LOGO STYLING */
        .logo-container { text-align: center; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        .logo-container img { max-width: 150px; height: auto; display: block; margin: 0 auto; }
        .logo-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-top: 10px; }

        /* HEADERS */
        h3 { margin: 10px 0 5px 0; font-size: 12px; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        
        /* SEARCH & INPUTS */
        .search-toggles { display: flex; gap: 15px; margin-bottom: 5px; }
        .search-toggles label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* SEARCH SUGGESTIONS */
        #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; z-index: 2000; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f1f1f1; }
        
        .coord-row { display: flex; gap: 5px; }
        .search-btn { background: #3498db; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .search-btn:hover { background: #2980b9; }

        /* LAYERS GRID */
        .layer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .layer-option { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; background: white; padding: 8px; border-radius: 4px; border: 1px solid #eee;}
        .layer-option:hover { background: #eef; }
        input[type="checkbox"] { transform: scale(1.1); cursor: pointer; }
        
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 100%; background: white; }
        
        button#downloadBtn { padding: 12px; background-color: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; font-size: 16px; transition: background 0.2s; }
        button#downloadBtn:hover { background-color: #219150; }
        button#downloadBtn.cancel-mode { background-color: #e74c3c !important; }
        button#downloadBtn.cancel-mode:hover { background-color: #c0392b !important; }
        
        #map { flex-grow: 1; position: relative; }
        #message { font-size: 13px; font-weight: bold; color: #555; min-height: 20px; padding: 10px; background: #e8f6f3; border-radius: 5px; border-left: 5px solid #1abc9c;}
        .hidden { display: none !important; }

        /* --- NEW: LOADING SPINNER OVERLAY --- */
        #loaderOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none; /* Hidden by default */
            flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-size: 18px; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="logo-container">
        <img src="logo.png" alt="MapForge" onerror="this.style.display='none'">
        <div class="logo-title">MapForge</div>
    </div>
    
    <h3>1. Navigate Map</h3>
    <div class="search-toggles">
        <label><input type="radio" name="searchMode" value="place" checked onchange="toggleSearchMode()"> Name</label>
        <label><input type="radio" name="searchMode" value="coords" onchange="toggleSearchMode()"> Coords</label>
    </div>

    <div id="placeSearchDiv" class="input-group">
        <input type="text" id="cityInput" placeholder="Start typing... (e.g. London)" autocomplete="off">
        <div id="suggestions"></div>
    </div>

    <div id="coordSearchDiv" class="input-group hidden">
        <div class="coord-row">
            <input type="number" id="latInput" placeholder="Lat" step="any">
            <input type="number" id="lonInput" placeholder="Lon" step="any">
        </div>
    </div>

    <button class="search-btn" onclick="executeSearch()">Go to Location</button>

    <h3>2. Select Area</h3>
    <div id="message">Use toolbar to draw area.</div>

    <h3>3. Select Layers</h3>
    <div class="layer-grid">
        <label class="layer-option"><input type="checkbox" value="buildings" checked> Buildings</label>
        <label class="layer-option"><input type="checkbox" value="streets" checked> Streets</label>
        <label class="layer-option"><input type="checkbox" value="water"> Water</label>
        <label class="layer-option"><input type="checkbox" value="parks"> Parks</label>
        <label class="layer-option"><input type="checkbox" value="schools"> Schools</label>
        <label class="layer-option"><input type="checkbox" value="medical"> Medical</label>
        <label class="layer-option"><input type="checkbox" value="railways"> Railways</label>
        <label class="layer-option"><input type="checkbox" value="power"> Power</label>
    </div>

    <h3>4. Export Format</h3>
    <select id="format">
        <optgroup label="Graphic Design">
            <option value="svg">SVG (Illustrator)</option>
            <option value="png">PNG (Photoshop)</option>
        </optgroup>
        <optgroup label="GIS Data">
            <option value="geojson">GeoJSON</option>
            <option value="shp">Shapefile (ESRI)</option>
            <option value="gpkg">GeoPackage</option>
        </optgroup>
    </select>

    <button id="downloadBtn" onclick="downloadData()">Download Selected</button>
</div>

<div id="map">
    <div id="loaderOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Generating Files...</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    var map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    var drawControl = new L.Control.Draw({
        draw: {
            polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#9b59b6' } },
            marker: false, circlemarker: false, polyline: false,
            rectangle: true, circle: true
        },
        edit: { featureGroup: drawnItems, remove: true }
    });
    map.addControl(drawControl);

    let currentLocationName = "Custom_Area"; 

    // --- SEARCH LOGIC ---
    const cityInput = document.getElementById('cityInput');
    const suggestionsBox = document.getElementById('suggestions');
    let debounceTimer;

    cityInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;
        if (query.length < 3) { suggestionsBox.style.display = 'none'; return; }
        debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
    });

    async function fetchSuggestions(query) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
            const data = await res.json();
            suggestionsBox.innerHTML = '';
            if (data.length === 0) { suggestionsBox.style.display = 'none'; return; }
            data.forEach(place => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = place.display_name;
                div.onclick = () => {
                    cityInput.value = place.display_name;
                    currentLocationName = place.display_name.split(',')[0].trim().replace(/\s+/g, '_');
                    suggestionsBox.style.display = 'none';
                    map.flyTo([place.lat, place.lon], 14);
                };
                suggestionsBox.appendChild(div);
            });
            suggestionsBox.style.display = 'block';
        } catch (e) {}
    }
    document.addEventListener('click', function(e) {
        if (e.target !== cityInput && e.target !== suggestionsBox) suggestionsBox.style.display = 'none';
    });

    function toggleSearchMode() {
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        document.getElementById('placeSearchDiv').classList.toggle('hidden', mode !== 'place');
        document.getElementById('coordSearchDiv').classList.toggle('hidden', mode !== 'coords');
    }

    async function executeSearch() {
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        if (mode === 'place') {
            const query = cityInput.value;
            if (!query) return;
            currentLocationName = query.split(',')[0].trim().replace(/\s+/g, '_');
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();
            if (data.length > 0) map.flyTo([data[0].lat, data[0].lon], 13);
            else alert("Location not found");
        } else {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lon = parseFloat(document.getElementById('lonInput').value);
            if (!isNaN(lat) && !isNaN(lon)) {
                currentLocationName = `${lat}_${lon}`;
                map.flyTo([lat, lon], 15);
            }
        }
    }

    // --- SELECTION LOGIC ---
    var selData = null;
    var selType = null;

    map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        selType = e.layerType;
        if (selType === 'circle') {
            selData = { lat: e.layer.getLatLng().lat, lon: e.layer.getLatLng().lng, radius: e.layer.getRadius() };
            document.getElementById('message').innerText = `‚úÖ Circle Selected (${Math.round(selData.radius)}m)`;
        } else if (selType === 'rectangle') {
            selType = 'bbox';
            var b = e.layer.getBounds();
            selData = { north: b.getNorth(), south: b.getSouth(), east: b.getEast(), west: b.getWest() };
            document.getElementById('message').innerText = "‚úÖ Rectangle Selected";
        } else if (selType === 'polygon') {
            var latlngs = e.layer.getLatLngs()[0];
            var coords = latlngs.map(pt => [pt.lat, pt.lng]);
            selData = { poly_coords: JSON.stringify(coords) };
            document.getElementById('message').innerText = "‚úÖ Polygon Shape Selected";
        }
    });

    map.on(L.Draw.Event.DELETED, function () { selData = null; document.getElementById('message').innerText = "Use toolbar to select area"; });

    function getFormattedDate() {
        const d = new Date();
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}${month}${year}`;
    }

    // --- DOWNLOAD & LOADER LOGIC ---
    let abortController = null;

    async function downloadData() {
        const btn = document.getElementById('downloadBtn');
        const msg = document.getElementById('message');
        const loader = document.getElementById('loaderOverlay'); // Get the spinner

        if (abortController) {
            abortController.abort();
            abortController = null;
            
            // RESET UI ON CANCEL
            btn.innerText = "Download Selected";
            btn.classList.remove('cancel-mode');
            loader.style.display = 'none'; // Hide spinner
            msg.innerText = "üö´ Download Cancelled.";
            return;
        }

        if (!selData) { alert("Draw an area first!"); return; }
        const checkboxes = document.querySelectorAll('.layer-grid input:checked');
        if (checkboxes.length === 0) { alert("Select a layer!"); return; }
        const layers = Array.from(checkboxes).map(cb => cb.value).join(',');
        const fmt = document.getElementById('format').value;

        abortController = new AbortController();
        const signal = abortController.signal;

        // START LOADING STATE
        btn.innerText = "Cancel Processing ‚ùå";
        btn.classList.add('cancel-mode');
        msg.innerText = "Processing in background...";
        loader.style.display = 'flex'; // Show spinner

        try {
            let params = new URLSearchParams({ layers: layers, type: selType, fmt: fmt });
            if (selType === 'bbox') {
                params.append('north', selData.north); params.append('south', selData.south);
                params.append('east', selData.east); params.append('west', selData.west);
            } else if (selType === 'circle') {
                params.append('lat', selData.lat); params.append('lon', selData.lon);
                params.append('radius', selData.radius);
            } else if (selType === 'polygon') {
                params.append('poly_coords', selData.poly_coords);
            }

            const res = await fetch(`/download?${params.toString()}`, { signal: signal });
            if (!res.ok) throw new Error((await res.json()).detail || "Error");
            
            const blob = await res.blob();
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            const ext = (fmt === 'shp' || ['geojson', 'gpkg'].includes(fmt)) ? 'zip' : fmt;
            const dateStr = getFormattedDate();
            link.download = `${currentLocationName}_${dateStr}.${ext}`;
            link.click();
            msg.innerText = "üéâ Download Complete!";

        } catch (e) {
            if (e.name === 'AbortError') msg.innerText = "üö´ Download Cancelled.";
            else msg.innerText = "‚ùå " + e.message;
        } finally {
            // ALWAYS RESET UI (Hide spinner, reset button)
            abortController = null;
            btn.innerText = "Download Selected";
            btn.classList.remove('cancel-mode');
            loader.style.display = 'none'; 
        }
    }
</script>
</body>
</html>